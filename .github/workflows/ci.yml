name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: |
          VET_OUTPUT=$(go vet ./... 2>&1) || true
          echo "$VET_OUTPUT"

          if [ -n "$VET_OUTPUT" ]; then
            echo "## ‚ö†Ô∏è Vet Warnings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$VET_OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # Fail the build on vet warnings
            exit 1
          fi

      - name: Run tests with JSON output
        run: |
          set -o pipefail
          go test -v -race -coverprofile=coverage.out -json ./... 2>&1 | tee test-results.json || echo "TEST_FAILED=true" >> $GITHUB_ENV

      - name: Check logic coverage
        run: |
          go test -coverprofile=logic.out ./internal/logic/
          COVERAGE=$(go tool cover -func=logic.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Logic package coverage: ${COVERAGE}%"
          # Fail if coverage is below 100%
          if [ "$(echo "$COVERAGE < 100" | bc)" -eq 1 ]; then
            echo "ERROR: internal/logic coverage must be 100%, got ${COVERAGE}%"
            exit 1
          fi

      - name: Generate HTML coverage report
        run: |
          go tool cover -html=coverage.out -o coverage.html
          go tool cover -func=coverage.out > coverage.txt

      - name: Generate test summary
        if: always()
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test counts
          PASSED=$(grep -c '"Action":"pass"' test-results.json 2>/dev/null | head -1 || echo 0)
          FAILED=$(grep -c '"Action":"fail"' test-results.json 2>/dev/null | head -1 || echo 0)
          SKIPPED=$(grep -c '"Action":"skip"' test-results.json 2>/dev/null | head -1 || echo 0)

          echo "| ‚úÖ Passed | ‚ùå Failed | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          echo "|:--------:|:--------:|:---------:|" >> $GITHUB_STEP_SUMMARY
          echo "| $PASSED | $FAILED | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Failed test output (most important - show first if any failures)
          if [ "$FAILED" -gt 0 ]; then
            echo "<details open>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>‚ùå Failed Test Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            jq -r 'select(.Action=="output") | select(.Test != null) | .Output // empty' test-results.json 2>/dev/null | head -200 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Coverage section
          echo "## üìä Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall coverage prominently displayed
          TOTAL=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "**Overall Coverage: $TOTAL**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Visual coverage heatmap by package
          echo "### Coverage by Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          for pkg in internal/logic internal/gpio internal/mqtt; do
            if go test -coverprofile=tmp.out ./$pkg/ 2>/dev/null; then
              COV=$(go tool cover -func=tmp.out | grep total | awk '{print $3}' | tr -d '%')
              if [ -n "$COV" ]; then
                # Create visual bar (10 blocks = 100%)
                FILLED=$(echo "$COV / 10" | bc)
                EMPTY=$((10 - FILLED))
                BAR=""
                for i in $(seq 1 $FILLED 2>/dev/null); do BAR+="‚ñà"; done
                for i in $(seq 1 $EMPTY 2>/dev/null); do BAR+="‚ñë"; done
                printf "%-20s %s %5.1f%%\n" "$pkg" "$BAR" "$COV" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Uncovered functions (actionable info)
          UNCOVERED=$(go tool cover -func=coverage.out | grep -v "100.0%" | grep -v "total:" || true)
          if [ -n "$UNCOVERED" ]; then
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>‚ö†Ô∏è Functions Below 100% Coverage</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$UNCOVERED" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Full function coverage details
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>üìã Full Function Coverage</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Slowest tests
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>üê¢ Slowest Tests (top 10)</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|" >> $GITHUB_STEP_SUMMARY
          jq -r 'select(.Action=="pass" and .Test != null and .Elapsed != null) | "\(.Package | split("/") | .[-1])/\(.Test)|\(.Elapsed)s"' test-results.json 2>/dev/null | \
            sort -t'|' -k2 -rn | head -10 | \
            while IFS='|' read test dur; do
              echo "| \`$test\` | $dur |" >> $GITHUB_STEP_SUMMARY
            done || true
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Fail if tests failed
        if: env.TEST_FAILED == 'true'
        run: exit 1

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.html
            coverage.txt
          retention-days: 30

  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm
            goarm: "6"
            suffix: linux-arm-pi-zero
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          go build -ldflags="-s -w" -o boiler-sensor-${{ matrix.suffix }} ./cmd/boiler-sensor
          chmod +x boiler-sensor-${{ matrix.suffix }}

      - name: Report binary size
        run: |
          SIZE=$(ls -lh boiler-sensor-${{ matrix.suffix }} | awk '{print $5}')
          SIZE_BYTES=$(ls -l boiler-sensor-${{ matrix.suffix }} | awk '{print $5}')
          echo "### üì¶ Binary: \`${{ matrix.suffix }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Size | **$SIZE** ($SIZE_BYTES bytes) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: boiler-sensor-${{ matrix.suffix }}
          path: boiler-sensor-${{ matrix.suffix }}
          retention-days: 90
